# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

desc "Deploy main branch"
lane :main do

    bump_build_number
    # gradle(task: "assembleDebug")
    # firebase_app_distribution(
    #     app: ENV["FIREBASE_APP_ID"],
    #     release_notes: ENV["RELEASE_NOTES"],
    #     groups: ENV["GROUPS"]
    # )
    build_number_to_commit = File.read("../versioning/BUILD_NUMBER")
    version_name = android_get_version_name
    git_commit(
        path: "./versioning/BUILD_NUMBER",
        message: "Version #{version_name} (#{build_number_to_commit}) distributed to Firebase"
    )
    # push_to_git_remote(
    #     tags: false
    # )
end

after_all do |main|
  slack(
    message: "New Android version of Babylon Wallet is released!",
    slack_url: ENV["SLACK_URL"],
    use_webhook_configured_username_and_icon: "false",
    username: "fastlane",
    icon_url: "https://fastlane.tools/assets/img/fastlane_icon.png",
    success: true
)
end

error do |main, exception|
  slack(
    message: exception.message,
    success: false
  )
end

lane :bump_build_number do

    current_build_number = File.read("../versioning/BUILD_NUMBER").to_i
    new_build_number = current_build_number + 1
    File.write("../versioning/BUILD_NUMBER", new_build_number, mode:"w")

    android_set_version_code(
        version_code: File.read("../versioning/BUILD_NUMBER"), # optional, if not specified, Version Code will be incremented
        gradle_file: "app/build.gradle"
    )

end

desc "Deploy release"
lane :release do
  gradle(task: "bundle")
end