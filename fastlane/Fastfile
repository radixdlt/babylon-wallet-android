# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

desc "Deploy merges to main and any other manual trigger"
lane :alpha do

  branch_name = git_branch
  version_name = android_get_version_name
  commit = last_git_commit
  ENV["RELEASE_NOTES"] = "Branch: " + branch_name + "\n" + "Commit: " + commit[:message]
  short_hash = commit[:abbreviated_commit_hash]
  version = version_name + "-" + short_hash
  android_set_version_name(
    version_name: version
  )
  gradle(
      task: "assemble",
      flavor: "Debug",
      build_type: "Alpha",
      properties: {
          "android.injected.signing.store.file" => ENV["RADIX_DEBUG_PREVIEW_KEYSTORE_FILE"],
          "android.injected.signing.store.password" => ENV["RADIX_ANDROID_KEYSTORE_PASSWORD"],
          "android.injected.signing.key.alias" => ENV["RADIX_ANDROID_KEYSTORE_ALIAS"],
          "android.injected.signing.key.password" => ENV["RADIX_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"]
        }
      )
  firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      release_notes: ENV["RELEASE_NOTES"],
      groups: ENV["GROUPS"]
  )

end

desc "Deploy pre-releases"
lane :preview do
    BUILD_NUMBER_FILE = "BUILD_NUMBER"
    bump_build_number versioning_file: "../versioning/#{BUILD_NUMBER_FILE}"
    gradle(
        task: "assemble",
        flavor: "Debug",
        build_type: "Preview",
        properties: {
            "android.injected.signing.store.file" => ENV["RADIX_DEBUG_PREVIEW_KEYSTORE_FILE"],
            "android.injected.signing.store.password" => ENV["RADIX_ANDROID_KEYSTORE_PASSWORD"],
            "android.injected.signing.key.alias" => ENV["RADIX_ANDROID_KEYSTORE_ALIAS"],
            "android.injected.signing.key.password" => ENV["RADIX_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"]
          }
        )
    firebase_app_distribution(
        app: ENV["FIREBASE_APP_ID"],
        release_notes: ENV["RELEASE_NOTES"],
        groups: ENV["GROUPS"]
    )
    build_number_to_commit = File.read("../versioning/#{BUILD_NUMBER_FILE}")
    version_name = android_get_version_name
    git_commit(
        path: "./versioning/#{BUILD_NUMBER_FILE}",
        message: "Version #{version_name} (#{build_number_to_commit}) distributed to Firebase"
    )
    push_to_git_remote(
        remote_branch: ENV["RELEASE_BRANCH"],
        tags: false
    )
end


desc "Deploy to Google Play Console"
lane :release_to_google_play do

    BUILD_NUMBER_FILE = "PLAYSTORE_BUILD_NUMBER"
    bump_build_number versioning_file: "../versioning/#{BUILD_NUMBER_FILE}"
    gradle(
        task: "bundle",
        build_type: "releasePreview",
        properties: {
            "android.injected.signing.store.file" => ENV["RADIX_DEBUG_PREVIEW_KEYSTORE_FILE"],
            "android.injected.signing.store.password" => ENV["RADIX_ANDROID_KEYSTORE_PASSWORD"],
            "android.injected.signing.key.alias" => ENV["RADIX_ANDROID_KEYSTORE_ALIAS"],
            "android.injected.signing.key.password" => ENV["RADIX_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"]
          }
        )

    upload_to_play_store(
        package_name: "com.babylon.wallet.android.preview",
        track: "internal",
        aab: Actions.lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH],
        skip_upload_apk: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        json_key: ENV["GOOGLE_PLAY_PREVIEW_DEPLOYER_JSON_FILE"]
        )

    build_number_to_commit = File.read("../versioning/#{BUILD_NUMBER_FILE}")
    version_name = android_get_version_name
    git_commit(
        path: "./versioning/#{BUILD_NUMBER_FILE}",
        message: "Version #{version_name} (#{build_number_to_commit}) distributed to Firebase"
    )
    push_to_git_remote(
        remote_branch: ENV["RELEASE_BRANCH"],
        tags: false
    )
end


# after_all do |beta|
#   slack(
#     message: "New Android version of Babylon Wallet is released!",
#     slack_url: ENV["SLACK_URL"],
#     use_webhook_configured_username_and_icon: "false",
#     username: "fastlane",
#     icon_url: "https://fastlane.tools/assets/img/fastlane_icon.png",
#     success: true
# )
# end

# error do |beta, exception|
#   slack(
#     message: exception.message,
#     success: false
#   )
# end

lane :bump_build_number do |options|

    current_build_number = File.read(options[:versioning_file]).to_i
    new_build_number = current_build_number + 1
    File.write(options[:versioning_file], new_build_number, mode:"w")

    android_set_version_code(
        version_code: File.read(options[:versioning_file]), # optional, if not specified, Version Code will be incremented
        gradle_file: "app/build.gradle"
    )

end